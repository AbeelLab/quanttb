# QuantTB

QuantTB is a SNP based method to identify and quantify individual strains present in Tuberculosis whole genome sequencing datasets. 

## Getting Started


These instructions will guide you through the process of using QuantTB, so that you can deploy it on your own local system. 

### Prerequisites
Python 2.x needs to be installed on your system to run QuantTB. (https://www.python.org/downloads/) Alternatively python can be installed using a package manager such as miniconda (https://conda.io/miniconda.html).  

Some functionalities of QuantTB require additional software to be installed on your system. 

* If wanting to make a reference SNP database based on assembly genomes (.fna/.fa files) MUMmer v3 is required: http://mummer.sourceforge.net/ 
* If wanting to generate a SNP profile for a fastq readset (.fq/.fastq files), samtools (v 1.7 or higher) and bwa (v. 0.7.17 or higher) need to be installed in your system and in your path. 
    * samtools download: https://sourceforge.net/projects/samtools/files/samtools/1.7/
    * BWA download: https://sourceforge.net/projects/bio-bwa/files/bwa-0.7.17.tar.bz2/download

### Installing

Download the latest release  of QuantTB from https://github.com/AbeelLab/quanttb/releases and install it on your computing environment.

```
tar -zxvf quanttb-1.0.0.tar.gz
cd quanttb-1.0.0
python setup.py install

```

QuantTB should now be installed.

## Running QuantTB

QuantTB can be used to make SNP databases, obtain snp profiles from fastq readsets, and classify strains.



#### Making a SNP database

A reference SNP database is required to classify samples. QuantTB comes prepackaged with it's own default database, however the user also has the ability to make their own. A SNP database can be made from different sources. A list of vcf files (.vcf), a list of assembly genomes (.fna/.fa/.fasta), a list of snp files output from MUMmer (.snps), or a list of snpprofiles (.samp) generated by quanttb. The command to make a snp database is 'makesnpdb'. The path to the reference files can be supplied by using the '-g' argument. 

```
# From VCF files
quanttb makesnpdb -g genome1.vcf genome2.vcf genome3.vcf ....

# From fna files. MUMmer must be installed on system
quanttb makesnpdb -g genome1.fna genome2.fna genome3.fna ....
```
Optionally, during construction of the snp database, quanttb can filter the snps and filter the genomes present to increase classification accuracy. SNPs can be filtered to remove those that are within a certain range of each other per genome using the 'reddist' argument. The default is 25. The database can be filtered to remove references that are within a certain genetic distance from each other using the 'filterdist' argument. By default there is no filtering of genomes.

```
# Removes snps from each genome that are within 50 snps from each other, and 
# removes references that differ by less than 100 snps 
quanttb makesnpdb -reddist 50 -filtedist 100 -g genome1.fna genome2.fna genome3.fna ....
```

A snpdb is output with the '.db' suffix which can be used in the 'quant' command to classify strains within a sample.

#### Quantifying individual strains in a sample

To classify strains in a sample using a reference genome, the command 'quant' is used. Quanttb accepts a list of fastq files (-f argument), and  vcf files (pilon), or .samp files  (-v argument) as input. In addition a reference snp database (.snpdb) needs to be used. QuantTB comes prepackaged with a database of 2166 TB genomes that differ by at least 100 snps. This is used as a default if no reference SNP database is supplied. QuantTB classifies strains using an iterative approach. The max number of iterations by default is set to 8, but this can be changed with the '-i' flag. 

```
# Classify a sample with default database and save results to output/results.txt
quanttb quant -f readset1.fq readset2.fq -o 'output/myresults.txt'

```
A result file containing the references observed in the sample is output to the specified location (default is output/results.txt). The output looks like the table below for a sample containing two strains. Every row in the output denotes the presence of a specific reference snp profile for the corresponding sample. The relative abundances are noted in the column 'relabundance' column.

|sample |refname|score  |relabundance | depth  |
|---    |---    |---    |---    |---    |
|readset1| tb_stainA    |   0.6    |    0.67   |  5.4     |
| readset1      |  strainB_tb     |    0.5   | 0.33      | 2.65      |




QuantTB can optionally find antibiotic resistant variants in the sample using a list of predetermined resistant mutations. Mutations in positions coding for antibiotic resistance can be output with the flag 'abres'

```
# Classify a sample with manually made database, and output antibiotic resistance results
quanttb quant -v sample1snps.vcf sample2snps.vcf sample3snps.vcf -abres

```
Antibiotic resistance results for all samples are output in a separate file, 'antibioticresistances.txt'. 

#### Getting variants

Fastq readsets need to be converted to a VCF file in order to be classified or be used as a reference genome in the database. This can optionally be done with the quanttb command: variants. The variants command accepts paired or single end fastq files as input. For multiple samples, the '-f' argument can be used repeatedly

```
# For one paired end readset
quanttb variants -f sample_1.fq sample_2.fq

# For two paired end readsets
quanttb variants -f sample_1.fq sample_2.fq  -f sample2_1.fq sample2_2.fq

```
This outputs a VCF file which can be used as input in snpdb or the quant command. 


## License

This project is licensed under the GNU GENERAL PUBLIC LICENSE- see the [LICENSE](LICENSE) file for details

## Contact

* Thomas Abeel : t.abeel@tudelft.nl
